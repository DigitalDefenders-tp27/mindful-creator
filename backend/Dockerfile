FROM python:3.11-slim
WORKDIR /app

# Install system tools for monitoring and logging
RUN apt-get update && \
    apt-get install -y --no-install-recommends git git-lfs procps && \
    git lfs install && \
    rm -rf /var/lib/apt/lists/*

# Add build info function
RUN echo '#!/bin/bash \n\
    echo "üîç System Info:" \n\
    echo "- Memory: $(free -h)" \n\
    echo "- Disk: $(df -h /)" \n\
    echo "- CPU: $(grep "model name" /proc/cpuinfo | head -1)" \n\
    ' > /usr/local/bin/sysinfo && \
    chmod +x /usr/local/bin/sysinfo

# Show initial system info
RUN echo "üì¶ Build started" && sysinfo

COPY requirements.txt .
RUN echo "üì• Installing dependencies..." && \
    pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    echo "‚úÖ Dependencies installed" && sysinfo

# Cache model download status to a file for later checking
RUN echo "‚è¨ Downloading NLP model (this may take several minutes)..." && \
    mkdir -p app/app/nlp && \
    echo "MODEL_DOWNLOAD_START=$(date +%s)" > /tmp/model_status.log && \
    git clone --depth 1 https://huggingface.co/spaces/Jet-12138/CommentResponse app/app/nlp || \
    (echo "‚ùå Model download failed. Creating empty model directory." && mkdir -p app/app/nlp) && \
    echo "MODEL_DOWNLOAD_END=$(date +%s)" >> /tmp/model_status.log

# Show model download status
RUN cd app/app/nlp && \
    if [ -f "pytorch_model.bin" ]; then \
        echo "‚úÖ Model files:" && \
        du -sh * | sort -hr && \
        echo "‚è±Ô∏è Download duration: $(($(grep END /tmp/model_status.log | cut -d= -f2) - $(grep START /tmp/model_status.log | cut -d= -f2))) seconds"; \
    else \
        echo "‚ö†Ô∏è Model file pytorch_model.bin not found"; \
    fi && \
    if [ -d ".git" ]; then rm -rf .git; fi && \
    sysinfo

COPY . .

# Show final build info
RUN echo "üèÅ Build completed" && \
    ls -la && \
    echo "üìÅ Application files:" && \
    find . -type f -not -path "*/\.*" -not -path "*/app/nlp/*" | wc -l && \
    echo "üì¶ Model directory size:" && \
    du -sh app/app/nlp || echo "Model directory not found" && \
    sysinfo

EXPOSE 8000
CMD ["sh", "railway_startup.sh"]