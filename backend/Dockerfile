FROM python:3.11-slim
WORKDIR /app

# å®‰è£…ç³»ç»Ÿå·¥å…·ç”¨äºç›‘æ§å’Œæ—¥å¿—
RUN apt-get update && \
    apt-get install -y --no-install-recommends git git-lfs procps && \
    git lfs install && \
    rm -rf /var/lib/apt/lists/*

# æ·»åŠ æ„å»ºä¿¡æ¯å‡½æ•°
RUN echo '#!/bin/bash \n\
    echo "ğŸ” System Info:" \n\
    echo "- Memory: $(free -h)" \n\
    echo "- Disk: $(df -h /)" \n\
    echo "- CPU: $(grep "model name" /proc/cpuinfo | head -1)" \n\
    ' > /usr/local/bin/sysinfo && \
    chmod +x /usr/local/bin/sysinfo

# æ˜¾ç¤ºåˆå§‹ç³»ç»Ÿä¿¡æ¯
RUN echo "ğŸ“¦ Build started" && sysinfo

COPY requirements.txt .
RUN echo "ğŸ“¥ Installing dependencies..." && \
    pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    echo "âœ… Dependencies installed" && sysinfo

# ç¼“å­˜æ¨¡å‹ä¸‹è½½çŠ¶æ€åˆ°ä¸€ä¸ªæ–‡ä»¶ä¾›åé¢æ£€æŸ¥
RUN echo "â¬ Downloading NLP model (this may take several minutes)..." && \
    mkdir -p app/app/nlp && \
    echo "MODEL_DOWNLOAD_START=$(date +%s)" > /tmp/model_status.log && \
    git clone --depth 1 https://huggingface.co/spaces/Jet-12138/CommentResponse app/app/nlp || \
    (echo "âŒ Model download failed. Creating empty model directory." && mkdir -p app/app/nlp) && \
    echo "MODEL_DOWNLOAD_END=$(date +%s)" >> /tmp/model_status.log

# æ˜¾ç¤ºæ¨¡å‹ä¸‹è½½åçš„çŠ¶æ€
RUN cd app/app/nlp && \
    if [ -f "pytorch_model.bin" ]; then \
        echo "âœ… Model files:" && \
        du -sh * | sort -hr && \
        echo "â±ï¸ Download duration: $(($(grep END /tmp/model_status.log | cut -d= -f2) - $(grep START /tmp/model_status.log | cut -d= -f2))) seconds"; \
    else \
        echo "âš ï¸ Model file pytorch_model.bin not found"; \
    fi && \
    if [ -d ".git" ]; then rm -rf .git; fi && \
    sysinfo

COPY . .

# æ˜¾ç¤ºæœ€ç»ˆæ„å»ºä¿¡æ¯
RUN echo "ğŸ Build completed" && \
    ls -la && \
    echo "ğŸ“ Application files:" && \
    find . -type f -not -path "*/\.*" -not -path "*/app/nlp/*" | wc -l && \
    echo "ğŸ“¦ Model directory size:" && \
    du -sh app/app/nlp || echo "Model directory not found" && \
    sysinfo

EXPOSE 8000
CMD ["sh", "railway_startup.sh"]